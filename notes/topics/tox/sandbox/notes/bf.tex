\documentclass[11pt,twoside,a4paper]{article}
% tlmgr conf texmf TEXMFHOME ~/.texmf && tlmgr init-usertree && tlmgr install bytefield
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{examplep}

\usepackage{tikz}
\usetikzlibrary{patterns,snakes}

\definecolor{lightcyan}{rgb}{0.84,1,1}
\definecolor{lightgreen}{rgb}{0.64,1,0.71}
\definecolor{lightblue}{rgb}{0.64,0.71,1}
\definecolor{lightpink}{rgb}{1,0.7,0.7}
\definecolor{lightred}{rgb}{1,0.7,0.71}
\definecolor{peachpuff}{rgb}{1,0.85,0.73}


\makeatletter
\tikzset{% customization of pattern
         % based on <m.wibrow@gm...> - 2013-03-24 07:20:
        hatch distance/.store in=\hatchdistance,
        hatch distance=100pt,
        hatch thickness/.store in=\hatchthickness,
        hatch thickness=5pt
        }
\pgfdeclarepatternformonly[\hatchdistance,\hatchthickness]{north east hatch}% name
    {\pgfqpoint{0pt}{0pt}}% below left
    {\pgfqpoint{\hatchdistance}{\hatchdistance}}% above right
    {\pgfpoint{\hatchdistance-\hatchthickness/1.4}{\hatchdistance-\hatchthickness/1.4}}%
    {
        \pgfsetcolor{\tikz@pattern@color}
        \pgfsetlinewidth{\hatchthickness}
        \pgfpathmoveto{\pgfqpoint{0pt}{0pt}}
        \pgfpathlineto{\pgfqpoint{\hatchdistance}{\hatchdistance}}
        \pgfusepath{stroke}
    }
\makeatother

\tikzset{encoded/.style={pattern=north east hatch, pattern color=teal!30, hatch distance=36pt, hatch thickness=10pt}}

\usepackage{bytefield}
\bytefieldsetup{bitheight=\widthof{~0x00~},bitwidth=0.03125\textwidth,boxformatting={\centering\small\sf}}

\newcommand{\hatchedbitbox}[4][lrtb]{\rlap{\bitbox[{#1}]{#3}{\tikz\fill[#2] (0,0) rectangle (\width,\height);}}\bitbox[{#1}]{#3}{#4}}
\newcommand{\hatchedskipbox}[2]{%
  \wordbox[lrb]{1}{\tikz\fill[#1] (0,0) -- ++(0,\height) -- ++(.9\width,0) [snake=coil,segment aspect=0,segment length=\height/2-4] -- (.9\width,0) [snake=none]-- cycle
    (.92\width,0) [snake=coil,segment aspect=0,segment length=\height/2-4] -- ++(0,\height) [snake=none] -- ++(.08\width,0) -- (\width,0) -- cycle
    node at (\width/2,\height/2) {#2};}}

\begin{document}

\begin{itemize}

\item \PVerb{NET_PACKET_LAN_DISCOVERY}\\[2ex]
\begin{bytefield}{32}
  \bitheader[endianness=little]{0,1,31} \\
  \hatchedbitbox{lightcyan}{1}{\rotatebox{90}{0x21}} &
  \hatchedbitbox{lightgreen}{31}{sender DHT public key} \\

  \bitheader[lsb=32,endianness=little]{32} \\
  \hatchedbitbox{lightgreen}{1}{}
\end{bytefield}


\item \PVerb{NET_PACKET_GET_NODES}\\[2ex]
\begin{bytefield}{32}
  \bitheader[endianness=little]{0,1,31} \\
  \hatchedbitbox{lightcyan}{1}{\rotatebox{90}{0x02}} &
  \hatchedbitbox{lightgreen}{31}{sender DHT public key (node id)} \\

  \bitheader[lsb=32,endianness=little]{32,33,56,57,63} \\
  \hatchedbitbox{lightgreen}{1}{} &
  \hatchedbitbox{lightpink}{24}{random nonce (24)} &
  \hatchedbitbox{encoded,preaction={fill,lightgreen}}{7}{query client id} \\

  \bitheader[lsb=64,endianness=little]{64,88,89,95} \\
  \hatchedbitbox{encoded,preaction={fill,lightgreen}}{25}{query client id} &
  \hatchedbitbox{encoded,preaction={fill,lightpink}}{7}{send back data (ping id)} \\

  \bitheader[lsb=96,endianness=little]{96,97,112} \\
  \hatchedbitbox{encoded,preaction={fill,lightpink}}{1}{} &
  \hatchedbitbox{encoded,preaction={fill,peachpuff}}{16}{MAC}
\end{bytefield}

\item \PVerb{NET_PACKET_SEND_NODES_IPV6}\\[2ex]
\begin{bytefield}{32}
  \bitheader[endianness=little]{0,1,31} \\
  \hatchedbitbox{lightcyan}{1}{\rotatebox{90}{0x04}} &
  \hatchedbitbox{lightgreen}{31}{sender DHT public key (node id)} \\

  \bitheader[lsb=32,endianness=little]{32,33,56,57,58,63} \\
  \hatchedbitbox{lightgreen}{1}{} &
  \hatchedbitbox{lightpink}{24}{random nonce (24)} &
  \hatchedbitbox{encoded,preaction={fill,lightgreen}}{1}{\rotatebox{90}{\# nod}} &
  \hatchedbitbox[lrt]{encoded,preaction={fill,lightblue}}{6}{} \\

  \hatchedskipbox{encoded,preaction={fill,lightblue}}{packed nodes} \\ \\

  \hatchedbitbox{encoded,preaction={fill,lightpink}}{8}{\parbox{\width}{\centering send back data\\ (ping id)}} &
  \hatchedbitbox{encoded,preaction={fill,peachpuff}}{16}{MAC}
\end{bytefield}


\item \PVerb{NET_PACKET_PING_REQUEST}\\[2ex]
\begin{bytefield}{32}
  \bitheader[endianness=little]{0,1,31} \\
  \hatchedbitbox{lightcyan}{1}{\rotatebox{90}{0x00}} &
  \hatchedbitbox{lightgreen}{31}{sender DHT public key (node id)} \\

  \bitheader[lsb=32,endianness=little]{32,33,56,57,58,63} \\
  \hatchedbitbox{lightgreen}{1}{} &
  \hatchedbitbox{lightpink}{24}{random nonce (24)} &
  \hatchedbitbox{encoded,pattern color=teal!30,preaction={fill,lightcyan}}{1}{\rotatebox{90}{0x00}} &
  \hatchedbitbox{encoded,pattern color=teal!30,preaction={fill,lightgreen}}{6}{ping id} \\

  \bitheader[lsb=64,endianness=little]{64,65,66,81} \\
  \hatchedbitbox{encoded,pattern color=lightred,preaction={fill,lightgreen}}{2}{\rotatebox{90}{\parbox{\widthof{~0x00~}}{\centering\scriptsize index \& 0x1ff}}} &
  \hatchedbitbox{encoded,pattern color=lightred,preaction={fill,peachpuff}}{16}{MAC}
\end{bytefield}



\item \PVerb{NET_PACKET_PING_RESPONSE}\\[2ex]
\begin{bytefield}{32}
  \bitheader[endianness=little]{0,1,31} \\
  \hatchedbitbox{lightcyan}{1}{\rotatebox{90}{0x01}} &
  \hatchedbitbox{lightgreen}{31}{sender DHT public key (node id)} \\

  \bitheader[lsb=32,endianness=little]{32,33,56,57,58,63} \\
  \hatchedbitbox{lightgreen}{1}{} &
  \hatchedbitbox{lightpink}{24}{random nonce (24)} &
  \hatchedbitbox{encoded,pattern color=teal!30,preaction={fill,lightcyan}}{1}{\rotatebox{90}{0x01}} &
  \hatchedbitbox{encoded,pattern color=teal!30,preaction={fill,lightgreen}}{6}{ping id} \\

  \bitheader[lsb=64,endianness=little]{64,65,66,81} \\
  \hatchedbitbox{encoded,pattern color=lightred,preaction={fill,lightgreen}}{2}{\rotatebox{90}{\parbox{\widthof{~0x00~}}{\centering\scriptsize index \& 0x1ff}}} &
  \hatchedbitbox{encoded,pattern color=lightred,preaction={fill,peachpuff}}{16}{MAC}
\end{bytefield}

\end{itemize}


% \begin{bytefield}[bitheight=\widthof{~0x00~},bitwidth=0.03125\textwidth,boxformatting={\centering\small\sf}]{32}
%   \bitheader[endianness=little]{0,8,16,24,31} \\
%   \colorbitbox{lightcyan}{1}{\rotatebox{90}{0x00}} &
%   \colorbitbox{lightgreen}{31}{sender DHT public key (node id)} \\

%   \bitheader[lsb=32,endianness=little]{32,40,48,56,63} \\
%   \colorbitbox{lightgreen}{1}{} &
%   \colorbitbox{lightpink}{24}{random nonce (24)} &
%   \hatchedbitbox{encoded,pattern color=teal!30,preaction={fill,lightcyan}}{1}{\rotatebox{90}{0x00}} &
%   \hatchedbitbox{encoded,pattern color=teal!30,preaction={fill,lightgreen}}{6}{ping id} \\

%   \bitheader[lsb=64,endianness=little]{64,72,80,88,95} \\
%   \hatchedbitbox{encoded,pattern color=lightred,preaction={fill,lightgreen}}{2}{ping id}
%   \hatchedbitbox{encoded,pattern color=lightred,preaction={fill,peachpuff}}{16}{MAC}
%   \bitheader[lsb=96,endianness=little]{96,104,112,120,127} \\
% \end{bytefield}
%   \begin{rightwordgroup}{RTP \\ Header}
% \end{rightwordgroup} \\


\end{document}



%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
